<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>E-Contract Demo</title>
  <style>
    body { font-family: sans-serif; max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    .container { display: flex; gap: 2rem; }
    .left-panel { flex: 1; }
    .right-panel { flex: 1; }
    .section { margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
    .preview-container { width: 100%; height: 600px; border: 1px solid #ccc; }
    textarea { width: 100%; box-sizing: border-box; }
    input[type="text"], input[type="file"] { width: 300px; padding: 0.5rem; }
    button { padding: 0.5rem 1rem; margin: 0.5rem 0; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .upload-section { border-color: #28a745; }
    .create-section { border-color: #007bff; }
    .sign-section { border-color: #ffc107; }
  </style>
</head>
<body>
  <h1>E-Contract Demo</h1>

  <div class="container">
    <div class="left-panel">
      <!-- Upload PDF Section -->
      <div class="section upload-section">
        <h2>üìÅ Upload Existing PDF</h2>
        <form id="uploadForm" enctype="multipart/form-data">
          <label>Title</label><br/>
          <input type="text" name="title" placeholder="my-document" required/><br/><br/>
          <label>PDF File</label><br/>
          <input type="file" name="file" accept=".pdf" required/><br/><br/>
          <button type="submit">Upload PDF</button>
        </form>
        <div id="uploadResult"></div>
      </div>

      <!-- Create New PDF Section -->
      <div class="section create-section">
        <h2>üìù Create Contract (HTML ‚Üí PDF)</h2>
        <form id="createForm">
          <label>Title</label><br/>
          <input type="text" name="title" placeholder="sample" required/><br/><br/>
          <label>HTML Content</label><br/>
          <textarea id="htmlContent" name="body_html" rows="25" placeholder="Enter HTML content here..."><h1>Sample Contract</h1>
<p>This is a sample contract body.</p>
<h2>Terms and Conditions</h2>
<ul>
  <li>Term 1: Sample term</li>
  <li>Term 2: Another term</li>
</ul>
<p><strong>Signature:</strong> ___________________</p></textarea><br/>
          <button type="button" id="previewBtn">üîç Preview PDF</button>
          <button type="submit">üìÑ Create PDF</button>
        </form>
        <div id="createResult"></div>
      </div>

      <!-- Sign Section -->
      <div class="section sign-section">
        <h2>‚úçÔ∏è Sign Document</h2>
        <div>
          <label>Document Title:</label>
          <input type="text" id="signTitle" placeholder="sample" required/>
        </div>
        <div style="margin: 1rem 0;">
          <button id="requestOtpBtn">üì± Request OTP</button>
          <div id="otpResult"></div>
        </div>
        <div>
          <input type="text" id="otpInput" placeholder="Enter OTP"/>
          <button id="signBtn">‚úçÔ∏è Sign Document</button>
        </div>
        <div id="signResult"></div>
      </div>

      <!-- Verify Section -->
      <div class="section">
        <h2>üîç Verify Signature</h2>
        <input type="text" id="verifyTitle" placeholder="sample"/>
        <button id="verifyBtn">Verify</button>
        <div id="verifyResult"></div>
      </div>
    </div>

    <div class="right-panel">
      <div class="section">
        <h2>üìÑ PDF Preview</h2>
        <iframe id="pdfPreview" class="preview-container" style="display: none;"></iframe>
        <div id="previewPlaceholder" class="preview-container" style="display: flex; align-items: center; justify-content: center; background: #f8f9fa; color: #6c757d;">
          Click "Preview PDF" to see your document here
        </div>
      </div>
    </div>
  </div>

  <script>
    // Auto-preview functionality
    let previewTimeout;
    document.getElementById('htmlContent').addEventListener('input', function() {
      clearTimeout(previewTimeout);
      previewTimeout = setTimeout(updatePreview, 1000); // Auto-preview after 1 second of no typing
    });

    document.getElementById('previewBtn').addEventListener('click', updatePreview);

    async function updatePreview() {
      const htmlContent = document.getElementById('htmlContent').value;
      if (!htmlContent.trim()) return;

      try {
        const formData = new FormData();
        formData.append('body_html', htmlContent);

        const response = await fetch('/contracts/preview', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          const pdfPreview = document.getElementById('pdfPreview');
          const placeholder = document.getElementById('previewPlaceholder');

          pdfPreview.src = 'data:application/pdf;base64,' + result.pdf_base64;
          pdfPreview.style.display = 'block';
          placeholder.style.display = 'none';
        } else {
          console.error('Preview failed:', response.statusText);
        }
      } catch (error) {
        console.error('Preview error:', error);
      }
    }

    // Upload form handler
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);

      try {
        const response = await fetch('/contracts/upload', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        document.getElementById('uploadResult').innerHTML = response.ok
          ? `<p style="color: green;">‚úÖ Uploaded: ${result.title}</p>`
          : `<p style="color: red;">‚ùå Error: ${result.detail}</p>`;
      } catch (error) {
        document.getElementById('uploadResult').innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
      }
    });

    // Create form handler
    document.getElementById('createForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);

      try {
        const response = await fetch('/contracts/create', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        document.getElementById('createResult').innerHTML = response.ok
          ? `<p style="color: green;">‚úÖ Created: ${result.title}</p>`
          : `<p style="color: red;">‚ùå Error: ${result.detail}</p>`;
      } catch (error) {
        document.getElementById('createResult').innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
      }
    });

    // Request OTP handler
    document.getElementById('requestOtpBtn').addEventListener('click', async function() {
      const title = document.getElementById('signTitle').value;
      if (!title) {
        alert('Please enter document title');
        return;
      }

      try {
        const response = await fetch(`/contracts/${title}/request-otp`, {
          method: 'POST'
        });

        const result = await response.json();
        document.getElementById('otpResult').innerHTML = response.ok
          ? `<p style="color: green;">‚úÖ ${result.message}</p>`
          : `<p style="color: red;">‚ùå Error: ${result.detail}</p>`;
      } catch (error) {
        document.getElementById('otpResult').innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
      }
    });

    // Sign document handler
    document.getElementById('signBtn').addEventListener('click', async function() {
      const title = document.getElementById('signTitle').value;
      const otp = document.getElementById('otpInput').value;

      if (!title || !otp) {
        alert('Please enter both title and OTP');
        return;
      }

      try {
        const formData = new FormData();
        formData.append('otp', otp);

        const response = await fetch(`/contracts/${title}/sign`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        document.getElementById('signResult').innerHTML = response.ok
          ? `<p style="color: green;">‚úÖ Signed: ${result.title}</p>`
          : `<p style="color: red;">‚ùå Error: ${result.detail}</p>`;
      } catch (error) {
        document.getElementById('signResult').innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
      }
    });

    // Verify signature handler
    document.getElementById('verifyBtn').addEventListener('click', async function() {
      const title = document.getElementById('verifyTitle').value;
      if (!title) {
        alert('Please enter document title');
        return;
      }

      try {
        const response = await fetch(`/contracts/${title}/verify`);
        const result = await response.json();

        if (response.ok) {
          document.getElementById('verifyResult').innerHTML = `
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
              <p><strong>Valid:</strong> ${result.valid ? '‚úÖ Yes' : '‚ùå No'}</p>
              <p><strong>Trusted:</strong> ${result.trusted ? '‚úÖ Yes' : '‚ùå No'}</p>
              <p><strong>Field:</strong> ${result.field_name}</p>
              <p><strong>Summary:</strong> ${result.summary}</p>
            </div>
          `;
        } else {
          document.getElementById('verifyResult').innerHTML = `<p style="color: red;">‚ùå Error: ${result.detail}</p>`;
        }
      } catch (error) {
        document.getElementById('verifyResult').innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
      }
    });

    // Initial preview
    updatePreview();
  </script>
</body>
</html>
